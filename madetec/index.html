<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat com IA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: #f5f5f5;
        }
        
        #chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-height: 100vh;
            padding: 10px;
        }
        
        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .message {
            margin-bottom: 15px;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        
        .user-message {
            color: #1a73e8;
            text-align: right;
        }
        
        .ai-message {
            color: #202124;
            text-align: left;
        }
        
        .error-message {
            color: #d32f2f;
            text-align: left;
            font-style: italic;
        }
        
        .message-sender {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        #input-area {
            display: flex;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        
        #message-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #dfe1e5;
            border-radius: 24px;
            outline: none;
            font-size: 16px;
            resize: none;
            height: auto;
            min-height: 48px;
            max-height: 120px;
            overflow-y: auto;
        }
        
        #send-button {
            margin-left: 10px;
            padding: 0 16px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        #send-button:hover {
            background-color: #1765cc;
        }
        
        #send-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        b {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-messages"></div>
        <div id="input-area">
            <textarea id="message-input" placeholder="Digite sua mensagem..." rows="1"></textarea>
            <button id="send-button">Enviar</button>
        </div>
    </div>

    <script>
        // Vari치veis globais
        const sessionId = 'session-' + Math.random().toString(36).substr(2, 9);
        const messageHistory = new Set();
        const IGNORE_MESSAGES = ["Workflow was started"];
        let pdfDownloaded = false;
        let pdfUrl = null; // Armazena a URL do PDF baixado
    
        // Fun칞칚o para verificar e baixar o PDF
        async function checkAndDownloadPdf() {
            if (pdfDownloaded || !pdfUrl) return;
            
            try {
                const pdfResponse = await fetch('https://api.muvecom.com.br/v1/spam?sessionId=' + sessionId, {
                    headers: { 'Accept': 'application/pdf' }
                });
                
                if (!pdfResponse.ok) throw new Error('Falha ao baixar PDF');
                
                const blob = await pdfResponse.blob();
                pdfUrl = URL.createObjectURL(blob);
                
                // Download autom치tico
                const a = document.createElement('a');
                a.href = pdfUrl;
                a.download = 'catalogo-madetec.pdf';
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                addMessage('IA', '游늯 <b>Cat치logo enviado!</b> Clique <a href="#" onclick="event.preventDefault(); window.open(\'' + pdfUrl + '\', \'_blank\');">aqui</a> se o download n칚o iniciou.', 'ai-message');
                pdfDownloaded = true;
                
            } catch (error) {
                console.error('Erro ao baixar PDF:', error);
                addMessage('Sistema', 'Erro ao enviar o cat치logo. Tente novamente mais tarde.', 'error-message');
            }
        }
    
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (message && !sendButton.disabled) {
                addMessage('Voc칡', message, 'user-message');
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                sendButton.disabled = true;
                sendButton.innerHTML = '<div class="loading"></div>';
                
                try {
                    const response = await fetch('https://api.muvecom.com.br/v1/resp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionId, chatInput: message })
                    });
                    
                    const responseText = await response.text();
                    
                    if (!response.ok) throw new Error(responseText || 'Erro ao processar mensagem');
    
                    // Verifica se precisa enviar PDF
                    if (responseText.includes('5BHor92uAR') && !pdfDownloaded) {
                        checkAndDownloadPdf(); // Chama a fun칞칚o de download
                    }
                    
                    // Exibe a mensagem (removendo o marcador)
                    const displayText = responseText.replace(/5BHor92uAR/g, '');
                    if (displayText && !shouldIgnoreMessage(displayText)) {
                        addMessage('IA', formatMessage(displayText), 'ai-message');
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    addMessage('Sistema', `Erro: ${error.message}`, 'error-message');
                } finally {
                    sendButton.disabled = false;
                    sendButton.textContent = 'Enviar';
                }
            }
        }
    
        // Inicializa칞칚o ap칩s carregamento da p치gina
        document.addEventListener('DOMContentLoaded', function() {
            // Configura os event listeners
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            sendButton.addEventListener('click', sendMessage);
        });
    </script>
</body>
</html>
